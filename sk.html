<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GT Mod Manager Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@google-labs/android-package-signer@0.0.1/dist/android-package-signer.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --card-hover: #2c2c2e;
            --border: #3a3a3c;
            --text: #ffffff;
            --text-muted: #8e8e93;
            --primary: #007aff;
            --success: #34c759;
            --danger: #ff3b30;
            --warning: #ff9500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Landscape Layout */
        .app-container {
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 16px;
            gap: 16px;
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .logo h1 {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
        }

        .logo p {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .nav-item {
            padding: 14px 16px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 15px;
            color: var(--text);
            background: transparent;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item i {
            width: 20px;
            font-size: 18px;
        }

        .nav-item.active, .nav-item:hover {
            background: var(--card-hover);
            color: var(--primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
        }

        .header-bar {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-actions button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
        }

        .content-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        /* Drag & Drop Zone */
        .drop-zone {
            grid-column: span 2;
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: var(--card);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(0, 122, 255, 0.1);
            transform: scale(1.02);
        }

        .drop-zone i {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .drop-zone h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .drop-zone p {
            font-size: 14px;
            color: var(--text-muted);
        }

        /* APK Upload */
        .apk-zone {
            grid-column: span 2;
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            background: var(--card);
            cursor: pointer;
        }

        .apk-item {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inject-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .inject-btn:hover {
            background: #28a745;
        }

        .inject-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
        }

        .scan-btn {
            background: var(--warning);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 8px;
        }

        .scan-btn:hover {
            background: #e68900;
        }

        /* Mod Card */
        .mod-card {
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .mod-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4);
        }

        .mod-card.conflict {
            border-left: 4px solid var(--danger);
        }

        .mod-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), #0056cc);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mod-name {
            font-weight: 600;
            font-size: 16px;
        }

        .mod-toggle {
            position: relative;
            width: 48px;
            height: 28px;
        }

        .mod-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 28px;
            transition: 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .slider {
            background: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .mod-body {
            padding: 16px;
        }

        .mod-path {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
            word-break: break-all;
        }

        .mod-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-info {
            background: rgba(0,122,255,0.2);
            color: var(--primary);
        }

        .btn-danger {
            background: rgba(255,59,48,0.2);
            color: var(--danger);
        }

        /* Library Grid */
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .library-card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
            position: relative;
        }

        .library-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .library-card i {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .library-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .library-author {
            font-size: 12px;
            color: var(--text-muted);
        }

        .download-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .library-card:hover .download-btn {
            opacity: 1;
        }

        /* Scanner Results */
        .scanner-results {
            grid-column: span 2;
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .scanner-results h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        .conflict-list {
            list-style: none;
            padding: 0;
        }

        .conflict-item {
            background: rgba(255,59,48,0.1);
            border-left: 3px solid var(--danger);
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
        }

        /* Instructions Tab */
        .instructions {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            line-height: 1.6;
            font-size: 14px;
            grid-column: span 2;
        }

        .instructions h3 {
            font-size: 18px;
            margin: 16px 0 8px;
            color: var(--primary);
        }

        .instructions ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .instructions li {
            margin: 6px 0;
        }

        .instructions code {
            background: #2c2c2e;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', monospace;
            font-size: 12px;
        }

        .warning-box {
            background: var(--warning);
            color: #000;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 13px;
        }

        /* Status Bar */
        .status-bar {
            padding: 12px 24px;
            background: var(--card);
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        /* Fun Fact */
        .fun-fact {
            background: linear-gradient(135deg, #34c759, #28a745);
            color: white;
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            text-align: center;
            font-weight: 500;
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.9; }
        }

        /* Progress */
        .progress {
            width: 100%;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .content-area {
                grid-template-columns: 1fr;
            }
            .drop-zone, .apk-zone {
                grid-column: span 1;
            }
        }

        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                overflow-x: auto;
            }
            .nav-item {
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <h1>GT Mod Manager</h1>
                <p>Quest Standalone • v2.3</p>
            </div>
            <button class="nav-item active" onclick="showSection('local')">
                <i class="fas fa-folder"></i> Local Mods
            </button>
            <button class="nav-item" onclick="showSection('library')">
                <i class="fas fa-cloud-download-alt"></i> Mod Library
            </button>
            <button class="nav-item" onclick="showSection('apk')">
                <i class="fas fa-mobile-alt"></i> APK Injector
            </button>
            <button class="nav-item" onclick="showSection('instructions')">
                <i class="fas fa-book"></i> Instructions
            </button>
            <button class="nav-item" onclick="scanMods()">
                <i class="fas fa-search"></i> Scan Mods
            </button>
            <button class="nav-item" onclick="exportConfig()">
                <i class="fas fa-download"></i> Export Config
            </button>
            <button class="nav-item" onclick="clearAll()">
                <i class="fas fa-trash"></i> Clear All
            </button>
            <div style="flex: 1;"></div>
            <div class="fun-fact">
                Fun Fact: Auto-signing makes your modded APKs install-ready in seconds!
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header-bar">
                <div class="header-title" id="sectionTitle">Local Mods</div>
                <div class="header-actions">
                    <button onclick="document.getElementById('fileInput').click()">Add DLLs</button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <!-- Local Mods -->
                <div id="localSection">
                    <div class="drop-zone" id="dropZone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Drag & Drop DLL Files Here</h3>
                        <p>Or click to select from your device</p>
                        <input type="file" id="fileInput" multiple accept=".dll" style="display: none;">
                    </div>
                    <div id="modsGrid" class="library-grid"></div>
                    <div id="scannerResults" class="scanner-results" style="display: none;"></div>
                </div>

                <!-- APK Injector -->
                <div id="apkSection" style="display: none;">
                    <div class="apk-zone" id="apkDropZone">
                        <i class="fas fa-file-archive"></i>
                        <h3>Upload Gorilla Tag APK</h3>
                        <p>Drag unmodified .apk here or click to select</p>
                        <input type="file" id="apkInput" accept=".apk" style="display: none;">
                    </div>
                    <div id="apksList"></div>
                    <div id="progressContainer" class="progress" style="display: none;">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>

                <!-- Mod Library -->
                <div id="librarySection" style="display: none; grid-column: span 2;">
                    <h2 style="grid-column: span 2; margin-bottom: 16px;">Popular Gorilla Tag Mods</h2>
                    <div class="library-grid" id="libraryGrid"></div>
                </div>

                <!-- Instructions -->
                <div id="instructionsSection" style="display: none;">
                    <div class="instructions">
                        <h3>Easy Mod Installation (Now with Auto-Sign!)</h3>
                        <p>APK Injector auto-signs for easy install. Mod Scanner detects conflicts!</p>

                        <h3>Step 1: Get Unmodified APK</h3>
                        <ul>
                            <li>Download from APKMirror or extract via CX File Explorer</li>
                        </ul>

                        <h3>Step 2: Add & Scan Mods</h3>
                        <ul>
                            <li>Add DLLs or download from Library</li>
                            <li>Click "Scan Mods" to check for conflicts (e.g., Bark + Camera)</li>
                            <li>Enable safe mods only</li>
                        </ul>

                        <h3>Step 3: Inject & Install</h3>
                        <ul>
                            <li>Upload APK → "Inject into [NAME]" (auto-adds BepInEx + mods + signs!)</li>
                            <li>Download signed modded.apk</li>
                            <li>Uninstall GT → Install via CX: Enable unknown sources → Launch!</li>
                        </ul>

                        <div class="warning-box">
                            ⚠️ Scanner is basic (name-based). Test in private. Auto-sign uses debug key – fine for Quest dev mode.
                        </div>

                        <h3>Tips</h3>
                        <ul>
                            <li>Conflicts? Disable one mod & re-scan</li>
                            <li>Large APKs? Browser may lag – use PC for big packs</li>
                            <li>Updates: Re-inject fresh base APK</li>
                        </ul>

                        <p><strong>Pro Tip:</strong> Scanner flags known risky combos from community reports!</p>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <span id="statusText">Ready • 0 mods loaded</span>
                <span>Last updated: <span id="lastUpdate">Never</span></span>
            </div>
        </div>
    </div>

    <script>
        // Data
        let mods = JSON.parse(localStorage.getItem('gtMods_v2')) || [];
        let apks = JSON.parse(localStorage.getItem('gtApks')) || [];
        let currentSection = 'local';

        // Popular Mods Library with Download URLs
        const modLibrary = [
            { name: "Bark", author: "janni", icon: "fas fa-volume-up", desc: "Voice chat & soundboard", download: "https://github.com/jaydendev/Bark/releases/latest/download/Bark.dll" },
            { name: "Utilla", author: "Gorilla Devs", icon: "fas fa-shield-alt", desc: "Anti-ban & private lobbies", download: "https://github.com/Gorilla-Tag/Utilla/releases/latest/download/Utilla.dll" },
            { name: "Monke Mod Manager", author: "DeadlyKitten", icon: "fas fa-cog", desc: "PC mod loader (Quest compatible)", download: "https://github.com/DeadlyKitten/MonkeModManager/releases/latest/download/MonkeModManager.dll" },
            { name: "Computer Interface", author: "Toni Macaroni", icon: "fas fa-desktop", desc: "In-game computer menu", download: "https://github.com/ToniMacaroni/ComputerInterface/releases/latest/download/ComputerInterface.dll" },
            { name: "Gorilla Cosmetics", author: "Fleece", icon: "fas fa-hat-cowboy", desc: "Hats, skins & cosmetics", download: "https://github.com/FleeceYT/GorillaCosmetics/releases/latest/download/GorillaCosmetics.dll" },
            { name: "Holdable Pad", author: "Dev", icon: "fas fa-gamepad", desc: "Custom holdable items", download: "https://github.com/AnotherAxiom/HoldablePad/releases/latest/download/HoldablePad.dll" },
            { name: "Camera Mod", author: "janni", icon: "fas fa-camera", desc: "Free camera & recording", download: "https://github.com/jaydendev/CameraMod/releases/latest/download/CameraMod.dll" },
            { name: "Map Loader", author: "Dev", icon: "fas fa-map", desc: "Custom maps & environments", download: "https://github.com/AnotherAxiom/MapLoader/releases/latest/download/MapLoader.dll" }
        ];

        // Known conflicts (name-based, from community reports)
        const knownConflicts = [
            { mods: ["Bark", "Camera Mod"], issue: "Audio-visual sync issues" },
            { mods: ["Monke Mod Manager", "Utilla"], issue: "Loader override conflicts" },
            { mods: ["Gorilla Cosmetics", "Map Loader"], issue: "Asset loading clashes" }
        ];

        // BepInEx ZIP URL (latest stable for IL2CPP)
        const bepinexUrl = 'https://github.com/BepInEx/BepInEx/releases/download/v6.0.0-be.704/BepInEx_UnityIL2CPP_x64_6.0.0-be.704.zip';

        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const apkInput = document.getElementById('apkInput');
        const apkDropZone = document.getElementById('apkDropZone');
        const modsGrid = document.getElementById('modsGrid');
        const libraryGrid = document.getElementById('libraryGrid');
        const apksList = document.getElementById('apksList');
        const statusText = document.getElementById('statusText');
        const lastUpdate = document.getElementById('lastUpdate');
        const sectionTitle = document.getElementById('sectionTitle');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const scannerResults = document.getElementById('scannerResults');

        // Initialize
        renderLocalMods();
        renderLibrary();
        renderApks();
        updateStatus();

        // Drag & Drop for DLLs
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFiles);

        // APK Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            apkDropZone.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            apkDropZone.addEventListener(eventName, () => apkDropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            apkDropZone.addEventListener(eventName, () => apkDropZone.classList.remove('dragover'), false);
        });

        apkDropZone.addEventListener('drop', handleApkDrop, false);
        apkDropZone.addEventListener('click', () => apkInput.click());
        apkInput.addEventListener('change', handleApkFiles);

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles({ target: { files } });
        }

        async function handleFiles(e) {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.dll'));
            for (let file of files) {
                if (!mods.some(m => m.name === file.name)) {
                    mods.push({
                        name: file.name,
                        path: file.webkitRelativePath || file.name,
                        enabled: true,
                        size: formatBytes(file.size),
                        added: new Date().toISOString(),
                        blob: file
                    });
                }
            }
            saveMods();
            renderLocalMods();
            updateStatus();
            fileInput.value = '';
        }

        function handleApkDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleApkFiles({ target: { files } });
        }

        function handleApkFiles(e) {
            const files = Array.from(e.target.files).filter(f => f.name.endsWith('.apk'));
            files.forEach(file => {
                if (!apks.some(a => a.name === file.name)) {
                    apks.push({
                        name: file.name,
                        size: formatBytes(file.size),
                        blob: file
                    });
                }
            });
            saveApks();
            renderApks();
            apkInput.value = '';
        }

        // Render Local Mods
        function renderLocalMods() {
            modsGrid.innerHTML = '';
            mods.forEach((mod, i) => {
                const card = document.createElement('div');
                card.className = `mod-card ${mod.conflict ? 'conflict' : ''}`;
                card.innerHTML = `
                    <div class="mod-header">
                        <div class="mod-name">${mod.name}</div>
                        <label class="mod-toggle">
                            <input type="checkbox" ${mod.enabled ? 'checked' : ''} onchange="toggleMod(${i})">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="mod-body">
                        <div class="mod-path">${mod.path}</div>
                        <div class="mod-actions">
                            <button class="btn btn-info" onclick="alert('Size: ${mod.size}\\nAdded: ${new Date(mod.added).toLocaleString()}')">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                            <button class="btn btn-danger" onclick="removeMod(${i})">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                modsGrid.appendChild(card);
            });
        }

        // Render Library with Download
        function renderLibrary() {
            libraryGrid.innerHTML = '';
            modLibrary.forEach((mod, i) => {
                const card = document.createElement('div');
                card.className = 'library-card';
                card.innerHTML = `
                    <button class="download-btn" onclick="downloadMod(${i}, event)" title="Download">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="${mod.icon}"></i>
                    <div class="library-name">${mod.name}</div>
                    <div class="library-author">by ${mod.author}</div>
                    <div style="font-size:11px; color:#aaa; margin-top:4px;">${mod.desc}</div>
                `;
                card.onclick = (e) => { if (!e.target.closest('.download-btn')) window.open(modLibrary[i].download.replace('/download/', '/releases/latest'), '_blank'); };
                libraryGrid.appendChild(card);
            });
        }

        async function downloadMod(index, e) {
            e.stopPropagation();
            const mod = modLibrary[index];
            try {
                const response = await fetch(mod.download);
                if (response.ok) {
                    const blob = await response.blob();
                    const file = new File([blob], mod.name, { type: 'application/octet-stream' });
                    const event = { target: { files: [file] } };
                    await handleFiles(event);
                    alert(`${mod.name} downloaded & added!`);
                } else {
                    alert('Download failed – check URL');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Mod Scanner
        function scanMods() {
            const enabledNames = mods.filter(m => m.enabled).map(m => m.name);
            const conflicts = [];
            knownConflicts.forEach(conflict => {
                const matching = conflict.mods.filter(m => enabledNames.includes(m));
                if (matching.length === conflict.mods.length) {
                    conflicts.push({ mods: conflict.mods, issue: conflict.issue });
                }
            });

            // Mark conflicts in mods
            mods.forEach(mod => {
                mod.conflict = conflicts.some(c => c.mods.includes(mod.name));
            });
            saveMods();
            renderLocalMods();

            // Show results
            if (conflicts.length > 0) {
                scannerResults.innerHTML = `
                    <h4>⚠️ Detected Conflicts:</h4>
                    <ul class="conflict-list">
                        ${conflicts.map(c => `<li class="conflict-item"><strong>${c.mods.join(' + ')}</strong>: ${c.issue}</li>`).join('')}
                    </ul>
                    <p>Disable one mod per conflict to resolve.</p>
                `;
                scannerResults.style.display = 'block';
            } else {
                scannerResults.innerHTML = '<h4>✅ No conflicts detected! Safe to inject.</h4>';
                scannerResults.style.display = 'block';
                setTimeout(() => scannerResults.style.display = 'none', 3000);
            }
        }

        // Render APKs
        function renderApks() {
            apksList.innerHTML = '';
            apks.forEach((apk, i) => {
                const div = document.createElement('div');
                div.className = 'apk-item';
                div.innerHTML = `
                    <span>${apk.name} (${apk.size})</span>
                    <div>
                        <button class="inject-btn" onclick="injectApk(${i})">Inject into ${apk.name}</button>
                        <button class="scan-btn" onclick="scanMods()">Scan Mods First</button>
                    </div>
                `;
                apksList.appendChild(div);
            });
        }

        // APK Injection with Auto-Sign
        async function injectApk(index) {
            const apk = apks[index];
            if (!apk.blob) return alert('APK file not found');

            // Quick scan reminder
            const enabledMods = mods.filter(m => m.enabled && m.blob);
            if (enabledMods.length === 0) {
                alert('Enable at least one mod first!');
                return;
            }
            if (enabledMods.some(m => m.conflict)) {
                if (!confirm('Conflicts detected! Proceed anyway?')) return;
            }

            progressContainer.style.display = 'block';
            try {
                updateProgress(10, 'Loading APK...');
                const apkZip = await JSZip.loadAsync(apk.blob);

                updateProgress(30, 'Fetching BepInEx...');
                const bepinexResponse = await fetch(bepinexUrl);
                const bepinexZip = await JSZip.loadAsync(await bepinexResponse.arrayBuffer());

                // Add BepInEx files
                bepinexZip.forEach((relativePath, bepinexFile) => {
                    if (!relativePath.endsWith('/')) {
                        apkZip.file(relativePath, bepinexFile.async('uint8array'));
                    }
                });

                // Create plugins folder
                let pluginsPath = 'BepInEx/plugins/';
                apkZip.folder(pluginsPath);

                // Add enabled mods
                updateProgress(60, 'Injecting mods...');
                for (let mod of enabledMods) {
                    const content = await mod.blob.arrayBuffer();
                    apkZip.file(pluginsPath + mod.name, content);
                }

                updateProgress(80, 'Generating & signing APK...');
                const unsignedContent = await apkZip.generateAsync({ type: 'uint8array' });

                // Auto-sign using Android Package Signer
                const signer = new AndroidPackageSigner.Signer();
                const signedContent = await signer.sign(unsignedContent, {
                    keyAlias: 'debug',
                    storePassword: 'android',
                    keyPassword: 'android'
                });

                const moddedApk = new Blob([signedContent], { type: 'application/vnd.android.package-archive' });
                const moddedFile = new File([moddedApk], `signed_modded_${apk.name}`, { type: 'application/vnd.android.package-archive' });

                // Download
                const url = URL.createObjectURL(moddedFile);
                const a = document.createElement('a');
                a.href = url;
                a.download = moddedFile.name;
                a.click();
                URL.revokeObjectURL(url);

                updateProgress(100, 'Done! Signed APK ready.');
                setTimeout(() => progressContainer.style.display = 'none', 2000);
                alert(`Injected & signed ${enabledMods.length} mods! Install on Quest.`);
            } catch (err) {
                console.error(err);
                alert('Injection/signing failed: ' + err.message + '\nTry fewer mods or check browser console.');
                progressContainer.style.display = 'none';
            }
        }

        function updateProgress(percent, text) {
            progressBar.style.width = percent + '%';
            statusText.textContent = text;
        }

        // Actions
        function toggleMod(i) {
            mods[i].enabled = !mods[i].enabled;
            saveMods();
            updateStatus();
        }

        function removeMod(i) {
            if (confirm(`Remove ${mods[i].name}?`)) {
                mods.splice(i, 1);
                saveMods();
                renderLocalMods();
                updateStatus();
            }
        }

        function showSection(section) {
            currentSection = section;
            ['localSection', 'librarySection', 'apkSection', 'instructionsSection'].forEach(id => {
                document.getElementById(id).style.display = section === id.replace('Section', '') ? (section === 'library' || section === 'instructions' ? 'block' : 'grid') : 'none';
            });
            sectionTitle.textContent = 
                section === 'local' ? 'Local Mods' : 
                section === 'library' ? 'Mod Library' : 
                section === 'apk' ? 'APK Injector' :
                'Installation Guide';
            document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showSection('${section}')"]`)?.classList.add('active');
        }

        function exportConfig() {
            const active = mods.filter(m => m.enabled).map(m => ({ name: m.name, path: m.path }));
            const data = { activeMods: active, exported: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gt_mods_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert(`Exported ${active.length} mods!`);
        }

        function clearAll() {
            if (confirm('Remove ALL mods & APKs? This cannot be undone.')) {
                mods = [];
                apks = [];
                saveMods();
                saveApks();
                renderLocalMods();
                renderApks();
                updateStatus();
            }
        }

        function saveMods() {
            localStorage.setItem('gtMods_v2', JSON.stringify(mods));
            lastUpdate.textContent = new Date().toLocaleTimeString();
        }

        function saveApks() {
            localStorage.setItem('gtApks', JSON.stringify(apks));
        }

        function updateStatus() {
            const enabled = mods.filter(m => m.enabled).length;
            statusText.textContent = `${mods.length} mods • ${enabled} enabled • ${apks.length} APKs`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Auto-save
        window.addEventListener('beforeunload', () => {
            saveMods();
            saveApks();
        });
    </script>
</body>
</html>